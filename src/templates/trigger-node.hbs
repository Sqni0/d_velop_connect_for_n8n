import {
	ITriggerFunctions,
} from 'n8n-core';

import {
	INodeType,
	INodeTypeDescription,
	ITriggerResponse,
} from 'n8n-workflow';

import { DvelopActionsApiClient } from '../api/client';

export class {{node.name}} implements INodeType {
	description: INodeTypeDescription = {
		displayName: '{{node.displayName}}',
		name: '{{node.name}}',
		icon: '{{node.icon}}',
		group: [{{#each node.group}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
		version: {{node.version}},
		description: '{{node.description}}',
		defaults: {
			name: '{{node.defaults.name}}',
		},
		inputs: [],
		outputs: ['main'],
		credentials: [
			{{#each node.credentials}}
			{
				name: '{{name}}',
				required: {{required}},
			},
			{{/each}}
		],
		webhooks: [
			{
				name: 'default',
				httpMethod: 'POST',
				responseMode: 'onReceived',
				path: 'webhook',
			},
		],
		properties: [
			{{#each node.properties}}
			{
				displayName: '{{displayName}}',
				name: '{{name}}',
				type: '{{type}}',
				required: {{required}},
				default: {{#if (eq type 'string')}}'{{default}}'{{else}}{{default}}{{/if}},
				{{#if description}}description: '{{description}}',{{/if}}
			},
			{{/each}}
		],
	};

	async trigger(this: ITriggerFunctions): Promise<ITriggerResponse> {
		const webhookUrl = this.getNodeWebhookUrl('default');
		const eventType = this.getNodeParameter('eventType') as string;

		// Get credentials
		const credentials = await this.getCredentials('dvelopApi');
		if (!credentials) {
			throw new Error('No credentials provided');
		}

		// Initialize API client
		const apiClient = new DvelopActionsApiClient({
			baseUrl: credentials.baseUrl as string,
			tenant: credentials.tenant as string,
			bearerToken: credentials.bearerToken as string,
			cookieAuth: credentials.cookieAuth as string,
		});

		// Register webhook with d.velop platform
		await this.registerWebhook(apiClient, eventType, webhookUrl);

		const manualTriggerFunction = async () => {
			return [
				{
					json: {
						message: 'Manual trigger executed',
						eventType: eventType,
						webhookUrl: webhookUrl,
						timestamp: new Date().toISOString(),
					},
				},
			];
		};

		return {
			manualTriggerFunction,
			closeFunction: async () => {
				// Unregister webhook when node is deactivated
				await this.unregisterWebhook(apiClient, eventType, webhookUrl);
			},
		};
	}

	private async registerWebhook(
		apiClient: DvelopActionsApiClient,
		eventType: string,
		webhookUrl: string
	): Promise<void> {
		try {
			// This would register a trigger/callback with the d.velop Actions app
			// Implementation depends on the specific API endpoints available
			console.log(`Registering webhook for event ${eventType} at ${webhookUrl}`);
		} catch (error) {
			console.error('Failed to register webhook:', error);
			throw error;
		}
	}

	private async unregisterWebhook(
		apiClient: DvelopActionsApiClient,
		eventType: string,
		webhookUrl: string
	): Promise<void> {
		try {
			// This would unregister the trigger/callback
			console.log(`Unregistering webhook for event ${eventType} at ${webhookUrl}`);
		} catch (error) {
			console.error('Failed to unregister webhook:', error);
			// Don't throw here as this is cleanup
		}
	}
}
